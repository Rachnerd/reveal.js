<section class="container__graphql">
    <img class="image" src="https://upload.wikimedia.org/wikipedia/commons/1/17/GraphQL_Logo.svg"/>
</section>
<section class="container__graphql-website">
    <iframe src="https://graphql.org/"></iframe>
</section>
<section class="container container__graphql-vs-rest">
    <div>
        <h1>REST</h1>

        <div>
            <img class="image" src="https://upload.wikimedia.org/wikipedia/commons/1/17/GraphQL_Logo.svg"/>
        </div>

    </div>
    <div>
        <ul>
            <li>Many endpoints</li>
            <li>Full resources</li>
            <li>Status codes</li>
            <li>Versioning</li>
        </ul>
        <ul>
            <li>One endpoint</li>
            <li>No over-fetching</li>
            <li>200</li>
            <li>No versioning</li>
        </ul>
    </div>
</section>

<section class="container__graphql-schema">
    <h2>Schema</h2>
    <div class="container">
        <div class="container__graphql-schema__code">
          <img src="assets/datamodel.png" />
        </div>
        <div class="container__graphql-schema__code">
            <iframe name="code-example"
                    src="data:text/html;charset=utf-8,%3Cbody%3E%3Cscript%20src%3D%22https%3A%2F%2Fgist.github.com%2FRachnerd%2Fb1df2f4c40f8bfa12210c8953eba8018.js%22%3E%3C%2Fscript%3E%3C%2Fbody%3E">
            </iframe>
        </div>
    </div>
</section>

<section>
    <h2>Resolving data</h2>
</section>

<section data-transition="slide-in fade-out">
    <h2>Query resolver</h2>
    <div>
        <img style="width: 80%" src="assets/sd1.png" />
    </div>
</section>

<section data-transition="none slide-out">
    <h2>Query resolver</h2>
    <div>
        <img style="width: 80%" src="assets/sd2.png" />
    </div>
</section>

<section>
    <h2>Query resolver</h2>
    <pre style="width: 100%;"><code class="hljs typescript" data-trim data-noescape>
        Query: {
            item: async (<span class="fragment">_</span>, <span class="fragment">{ id }</span>, <span class="fragment">{ itemService }</span>, <span
            class="fragment">_info</span>) => {
                <span class="fragment">const item = await itemService.getById(id);</span>
                <span class="fragment">return item ? GqlItem.transform(item): null;</span>
            }
        }
	</code></pre>
</section>

<section data-transition="slide-in fade-out">
    <h2>Type resolver</h2>
    <div>
        <img style="width: 80%" src="assets/sd3.png" />
    </div>
</section>

<section data-transition="none slide-out">
    <h2>Type resolver</h2>
    <div>
        <img style="width: 80%" src="assets/sd4.png" />
    </div>
</section>

<section>
    <h2>Item resolver</h2>
    <pre style="width: 100%;"><code class="hljs typescript" data-trim data-noescape>

        Item: {
            <span class="fragment">averageRating: async ({ id }, _, { reviewService }) => {
                return reviewService.calcAverageRating(id);
            },</span>
            <span class="fragment">reviews: async ({ id }, _, { reviewService }) => {
                return reviewService.findByItemId(id)
                            .map(review => GqlReviewDto.transform(review));
            },</span>
            <span class="fragment">seller: async ({ userId }, _, { userService }) => {
                const user = userService.getUser(id);
                return user ? GqlUserDto.transform(user): null;
            }</span>
        }
	</code></pre>
</section>

<section>
    <h2>Review resolver</h2>
    <pre style="width: 100%;"><code class="hljs typescript" data-trim data-noescape>
        Review: {
            author: async ({ userId }, _, { userService }) => {
                const user = userService.getUser(userId);
                return user ? GqlUserDto.transform(user): null;
            }
        }
	</code></pre>
</section>

<section>
    <h2>Dataloader</h2>
</section>

<section>
    <h2>User data loader</h2>
    <pre style="width: 100%;"><code class="hljs typescript" data-trim data-noescape>
        export const userDataLoader = new DataLoader(async (ids: string[]) {
            return userService.getByIds(ids);
        });
	</code></pre>
    <pre style="width: 100%;"><code class="hljs typescript fragment" data-trim data-noescape>
        Review: {
            author: async ({ userId }, _, { userDataLoader }) => {
                const user = <mark>userDataLoader.load(userId);</mark>
                return user ? GqlUserDto.transform(user): null;
            }
        }
	</code></pre>
</section>

<!--<section>-->
<!--    <div>-->
<!--        <h2>Service/HTTP calls</h2>-->
<!--        <h4>5 items with each 10 reviews</h4>-->
<!--        <ul>-->
<!--            <li>5x Item by id</li>-->
<!--            <li>50x Review by id</li>-->
<!--            <li>(5+50)x User by id</li>-->
<!--            <li>110 calls total</li>-->
<!--        </ul>-->
<!--    </div>-->
<!--</section>-->

<!--<section>-->
<!--    <div>-->
<!--        <h3>Service/HTTP calls + dataloader</h3>-->
<!--        <h4>5 items with each 10 reviews</h4>-->
<!--        <ul>-->
<!--            <li>1x batch Items by id</li>-->
<!--            <li>1x batch Reviews by id</li>-->
<!--            <li>(1+1)x batch Users by id</li>-->
<!--            <li>4 calls total</li>-->
<!--        </ul>-->
<!--    </div>-->
<!--</section>-->

<section style="display: flex; justify-content: center; align-items: center">
    <img src="https://graphql-code-generator.com/img/gql-codegen-cover.png" alt="codegen" width="400"/>
</section>

<section>
    <div style="display: flex">
        <div style="flex: 1; border-right: 1px solid black; border-bottom: 1px solid black; position: relative">
             <pre><code class="hljs" data-noescape>schema: ./src/schema.graphql
overwrite: true
generates:
  ./.generated/gql.model.ts:
    plugins:
      - typescript
      - typescript-resolvers
    config:
      typesPrefix: GQL
    </code></pre>
            <img src="https://graphql-code-generator.com/img/gql-codegen-cover.png" alt="codegen" width="80"
                 style="position: absolute; bottom: 0; right: 10px"/>
        </div>
        <div style="flex: 1;"><pre><code style="overflow: hidden" class="hljs typescript" data-trim data-noescape>
export type GQLItem = {
  __typename?: 'Item',
  id: Scalars['ID'],
  name: Scalars['String'],
  description: Scalars['String'],
  image: Scalars['String'],
  averageRating: Scalars['Float'],
  reviews: Array&lt;GQLReview>,
  seller: GQLUser,
}
    </code></pre>
        </div>
    </div>

    <pre style="width: 100%;"><code class="hljs typescript" data-trim>
export type GQLItemResolvers&lt;...&gt; = {
  id?: Resolver&lt;GQLResolversTypes['ID'], ...&gt;,
  name?: Resolver&lt;GQLResolversTypes['String'], ...&gt;,
  description?: Resolver&lt;GQLResolversTypes['String'], ...&gt;,
  image?: Resolver&lt;GQLResolversTypes['String'], ...&gt;,
  averageRating?: Resolver&lt;GQLResolversTypes['Float'], ...&gt;,
  seller?: Resolver&lt;GQLResolversTypes['User'], ...&gt;,
  reviews?: Resolver&lt;Array&lt;GQLResolversTypes['Review']&gt;, ...&gt;,
};</code></pre>
    <aside class="notes">
        Now we can see if clients and server are compatible at compile time.
    </aside>
</section>

<section>
    <h2>Improving the schema</h2>
</section>
<section>
    <h2>Pagination</h2>
</section>

<section>
    <h2>Pagination</h2>
    <div style="display: flex; justify-content: space-around">
        <div>

            <p>Schema</p>
            <pre style="width: 100%; font-size: .4em;"><code class="hljs graphql">type Query {
    item(id: ID!): Item
}

type Item {
    ...
    reviews(page: Int, size: Int): ReviewPage!
}

type ReviewPage {
    content: [Review!]!
    page: Int!
    size: Int!
    totalPages: Int!
    totalElements: Int!
}
  </code></pre>
        </div>
        <div class="divider"></div>
        <div>

            <p>Query</p>
            <pre style="width: 100%; font-size: .4em;"><code class="hljs graphql">{
  item(id: 1) {
    id
    name
    description
    image
    reviews(page: 0, size: 10) {
      page
      size
      totalPages
      totalElements
      content: {
        description
        rating
      }
    }
  }
}
        </code></pre>
        </div>

    </div>
</section>

<section>
    <h2>Union Types</h2>
</section>

<section>
    <h2>ItemResult union</h2>
    <div style="display: flex; justify-content: space-around">
        <div>

            <p>Schema</p>
            <pre style="width: 100%; font-size: .5em;"><code class="hljs graphql">type Query {
    item(id: ID!): ItemResult
}

union ItemResult = Item | ReplacedItem

type Item {
    ...
}

type ReplacedItem {
    id: ID!
    reason: String!
    replacement: Item!
}
  </code></pre>
        </div>
        <div class="divider"></div>
        <div>

            <p>Query</p>
            <pre style="width: 100%; font-size: .4em;"><code class="hljs graphql">{
  item(id: 1) {
    __typename
    ... on Item {
      id
      name
      description
      image
    }
    ... on ReplacedItem {
      id
      reason
      replacement {
        id
        name
      }
    }
  }
}
        </code></pre>
        </div>

    </div>
</section>

<section>
    <h2>Union resolver</h2>
    <div style="display: flex">
  <pre style="width: 100%; font-size: .5em; background-color: #3f3f3f" data-trim=""><code class="hljs typescript">ItemResult: {
    __resolveType(itemResult, context, info) {

      if('replacement' in itemResult){
        return 'ReplacedItem';
      }

      if('name' in itemResult){
        return 'Item';
      }

      return null;
    }
}
  </code></pre>
    </div>
</section>

<section>
    <h2>Union responses</h2>
    <div style="display: flex; justify-content: space-around">
  <pre style="width: 100%; font-size: .5em;"><code class="hljs json">{
  "data": {
    "itemResult": {
      "__typename": "Item",
      "id": "92ea9f58",
      "name": "Hammer",
      "description": "Don't miss!",
      "image": "media-server/hammer.png"
    }
  }
}


        </code></pre>
        <div class="divider">&nbsp;</div>
        <pre style="width: 100%; font-size: .5em;"><code class="hljs json">{
  "data": {
    "itemResult": {
      "__typename": "ReplacedItem",
      "id": "ce1ed207",
      "reason": "Old model",
      "replacement": {
        "id": "53d08d7c",
        "name": "Hammer v2",
      }
    }
  }
}
  </code></pre>
    </div>
</section>

<section>
    <h2>union components</h2>
    <div style="display: flex">
        <div style="display: flex; flex-direction: column; align-items: center">
            <img src="https://miro.medium.com/max/816/1*mn6bOs7s6Qbao15PMNRyOA.png" alt="codegen" width="120"/>
            <img src="https://graphql-code-generator.com/img/gql-codegen-cover.png" alt="codegen" width="120"/>
            <img style="width: 6em"
                 src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/React-icon.svg/1920px-React-icon.svg.png"
                 alt="react"/>

        </div>
        <pre style="width: 100%; font-size: .4em; background-color: #3f3f3f"><code class="hljs tsx"
                                                                                   data-noescape><span
                style="opacity: .4">interface ItemResultProps {
    result: GQLItemResult;
}

const ItemResult: React.FC&lt;ItemResultProps> = ({ result }) => {</span>
  switch (result.__typename) {
    case "Item":
      return &lt;Item item={result} />;
    case "ReplacedItem": {
      const { reason, replacement } = result;
      return (
        &lt;>
          &lt;Notification message={reason} />
          &lt;Item item={replacement} />
        &lt;/>
      );
    }
  <span style="opacity: .4">}
  return null;
};</span></code></pre>
    </div>
</section>

<section>
    <h2>Error handling</h2>
</section>

<section>
    <h2>Functional errors</h2>
    <div style="display: flex; justify-content: space-around">
        <div>

            <p>Schema</p>
            <pre style="width: 100%; font-size: .4em;"><code class="hljs graphql" data-noescape><span
                    style="opacity: .4">type Query {
      item(id: ID!): ItemResult</span><span class="fragment" data-fragment-index="0">!</span>
<span style="opacity: .4">}

union ItemResult = Item | ReplacedItem</span>
    <span class="fragment" data-fragment-index="0">| NotFound</span><span style="opacity: .4">

type Item {
    ...
}

type ReplacedItem {
    ...
}
</span><span class="fragment" data-fragment-index="0">
type NotFound {
    id: ID!
}</span></code></pre>
        </div>

        <div class="divider"></div>
        <div>

            <p>Query</p>
            <pre style="width: 100%; font-size: .5em;"><code class="hljs graphql" data-noescape><span style="opacity: .4">{
  item(id: 1) {
    __typename
    ... on Item {
      #...
    }
    ... on ReplacedItem {
      #...
    }
    </span><span class="fragment">... on NotFound {
        id
    }</span><span style="opacity: .4">
  }
}</span>
            </code></pre>
        </div>
    </div>
</section>

<section>
    <h2>Error components</h2>
    <div style="display: flex">
        <div style="display: flex; flex-direction: column; align-items: center">
            <img src="https://miro.medium.com/max/816/1*mn6bOs7s6Qbao15PMNRyOA.png" alt="codegen" width="120"/>
            <img src="https://graphql-code-generator.com/img/gql-codegen-cover.png" alt="codegen" width="120"/>
            <img style="width: 6em"
                 src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/React-icon.svg/1920px-React-icon.svg.png"
                 alt="react"/>

        </div>
        <pre style="width: 100%; font-size: .4em; background-color: #3f3f3f"><code class="hljs typescript"
                                                                                   data-noescape><span
                style="opacity: .4">interface ItemResultProps {
    result: GQLItemResult;
}

const ItemResult: React.FC&lt;ItemResultProps> = ({ result }) => {
  switch (result.__typename) {
    case "Item":
      // ...
    case "ReplacedItem": {
      // ...
    </span><span class="fragment">case "NotFound": {
      const { id } = result;
      return &lt;NotFound id={id} resource={"Item"}/>;
    }</span><span style="opacity: .4">
  }
  return null;
};</span></code></pre>
    </div>
</section>

<section>
    <h2>Conclusion</h2>
    <ul>
        <li>Single source of truth</li>
        <li>Strong compile time coupling clients/server</li>
        <li>Functional edge-cases in schema</li>
        <li>Functional errors in schema</li>
    </ul>
</section>

<section>
    <h1>Q&A</h1>
</section>